import streamlit as st 
import PyPDF2
from langchain.text_splitter import CharacterTextSplitter
from langchain.vectorstores import FAISS
from langchain.embeddings import HuggingFaceInstructEmbeddings
from langchain.chat_models import ChatOpenAI
from langchain.llms import HuggingFaceHub
from langchain.memory import ConversationBufferMemory
from langchain.chains import ConversationalRetrievalChain

import os

vectordb_path = "faiss_index"

css = '''
<style>
.chat-message {
    padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex
}
.chat-message.user {
    background-color: #2b313e
}
.chat-message.bot {
    background-color: #475063
}
.chat-message .avatar {
  width: 20%;
}
.chat-message .avatar img {
  max-width: 78px;
  max-height: 78px;
  border-radius: 50%;
  object-fit: cover;
}
.chat-message .message {
  width: 80%;
  padding: 0 1.5rem;
  color: #fff;
}
'''

bot_template = '''
<div class="chat-message bot">
    <div class="avatar">
        <img src="data:image/jpeg;base64,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" style="max-height: 78px; max-width: 78px; border-radius: 50%; object-fit: cover;">
    </div>
    <div class="message">{{MSG}}</div>
</div>
'''

user_template = '''
<div class="chat-message user">
    <div class="avatar">
        <img src="data:image/jpeg;base64,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">
    </div>    
    <div class="message">{{MSG}}</div>
</div>
'''


def read_text_from_pdf(pdfs):
    text = ""
    for pdf in pdfs:
        pdfReader = PyPDF2.PdfReader(pdf)
        for page in pdfReader.pages:
            text += page.extract_text()
    return text

def create_chunks(text):
    splitter = CharacterTextSplitter(separator="\n", chunk_size=1000, chunk_overlap=200, length_function=len)
    chunks = splitter.split_text(text)
    return chunks

def create_vectordb(chunks):
    embed = HuggingFaceInstructEmbeddings(model_name="hkunlp/instructor-xl")
    vector = FAISS.from_texts(chunks, embed)
    vector.save_local(vectordb_path)
    return vector
    
def conversion_chain(embed):
    llm = HuggingFaceHub(
        repo_id="google/flan-t5-xxl", 
        model_kwargs={"temperature":0.3, "max_length":512})
    memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)
    conversation_chain = ConversationalRetrievalChain.from_llm(
        llm=llm,
        retriever=embed.as_retriever(),
        memory=memory
    )
    return conversation_chain

def handle_input(user_question):
    response = st.session_state.conversation({"question":user_question})
    st.session_state.chat_history = response["chat_history"]
    
    # Reverse the order of each Q&A pair
    reversed_chat_history = list(reversed(st.session_state.chat_history))


    for i, message in enumerate(reversed_chat_history):
        if i % 2 == 0:
            st.write(bot_template.replace("{{MSG}}", message.content), unsafe_allow_html=True)
        else:
            st.write(user_template.replace("{{MSG}}", message.content), unsafe_allow_html=True)
        # st.write(message)

def main():
    st.title("Chat with multiple PDFs")
    st.header("This app will help you to chat with multiple PDFs")
    st.write(css, unsafe_allow_html=True)
    
    if "conversation" not in st.session_state:
        st.session_state.conversation = None

    if "chat_history" not in st.session_state:
        st.session_state.chat_history = None
    
    user_question = st.text_input("Ask a question about your documents:")
    if user_question:
        handle_input(user_question)
    
    with st.sidebar:
        st.header("Upload PDFs")
        pdfs = st.file_uploader("Upload PDFs", type="pdf", accept_multiple_files=True)
        
        process_btn = st.button("Process")
        if process_btn:
            with st.spinner("Processing..."):
                
                #extract text from pdf
                text = read_text_from_pdf(pdfs)
                
                #split text
                chunks = create_chunks(text)
                
                #create embedding
                embedding = create_vectordb(chunks)
                
                st.session_state.conversation = conversion_chain(embedding) 
                
            st.write("Processed!")
            processed = True
    
if __name__ == "__main__":
    main()
    